apiVersion: apps/v1
kind: Deployment
metadata:
 name: {#PROJECT_NAME_KEBAB_LOWERCASE#}-app-api-deployment
 labels:
   app: {#PROJECT_NAME_KEBAB_LOWERCASE#}-app-api
spec:
 replicas: 2
 selector:
   matchLabels:
     app: {#PROJECT_NAME_KEBAB_LOWERCASE#}-app-api
 template:
   metadata:
     labels:
       app: {#PROJECT_NAME_KEBAB_LOWERCASE#}-app-api
   spec:
     serviceAccountName: mobio
     containers:
       - name: {#PROJECT_NAME_KEBAB_LOWERCASE#}
         image: {image}
         imagePullPolicy: IfNotPresent
         command: ["/bin/sh", "-c"]
         args: ["cd ${#PROJECT_NAME_SNAKE_UPPERCASE#}_HOME; sh prepare_env.sh && uwsgi --http :{#PROJECT_PORT#} --wsgi-file app_{#PROJECT_NAME_SNAKE_LOWERCASE#}_api.py --callable app --master --processes 4 -b 65536 --lazy --enable-threads"]
         envFrom:
           - configMapRef:
               name: mobio-config
           - secretRef:
               name: mobio-secret
         ports:
           - containerPort: {#PROJECT_PORT#}
         resources:
           requests:
             memory: 70Mi
             cpu: 80m
           limits:
             memory: 1Gi
             cpu: 800m
         volumeMounts:
           - name: mobio-shared-data
             mountPath: /media/data/resources/
         livenessProbe:
           httpGet:
             port: {#PROJECT_PORT#}
             path: /api/v1.0/ping
           initialDelaySeconds: 120
           periodSeconds: 5
           timeoutSeconds: 4
           successThreshold: 1
           failureThreshold: 3
     initContainers:
       - name: init-{#PROJECT_NAME_KEBAB_LOWERCASE#}
         image: {image}
         command: [ '/bin/sh', '-c', "cd ${#PROJECT_NAME_SNAKE_UPPERCASE#}_HOME; sh prepare_env.sh && sh check_image.sh" ]
         envFrom:
           - configMapRef:
               name: mobio-config
           - secretRef:
               name: mobio-secret
         volumeMounts:
           - name: mobio-shared-data
             mountPath: /media/data/resources/
           - name: mobio-public-shared-data
             mountPath: /media/data/public_resources/
     imagePullSecrets:
       - name: registrypullsecret
     volumes:
       - name: mobio-shared-data
         persistentVolumeClaim:
           claimName: mobio-resources-pvc
---
apiVersion: v1
kind: Service
metadata:
 name: {#PROJECT_NAME_KEBAB_LOWERCASE#}-app-api-service
 labels:
   app: {#PROJECT_NAME_KEBAB_LOWERCASE#}-app-api
spec:
 ports:
   - port: {#PROJECT_PORT#}
 selector:
   app: {#PROJECT_NAME_KEBAB_LOWERCASE#}-app-api
