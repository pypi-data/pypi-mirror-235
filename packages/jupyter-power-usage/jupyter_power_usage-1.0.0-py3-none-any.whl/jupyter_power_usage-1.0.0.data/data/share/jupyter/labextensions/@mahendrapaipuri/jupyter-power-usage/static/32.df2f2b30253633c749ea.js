"use strict";(self.webpackChunk_mahendrapaipuri_jupyter_power_usage=self.webpackChunk_mahendrapaipuri_jupyter_power_usage||[]).push([[32],{32:(e,t,n)=>{n.r(t),n.d(t,{default:()=>B});var r=n(861),i=n(684),s=n(29),a=n.n(s),o=n(496);const l=({percentage:e,color:t})=>a().createElement("div",{className:"jp-IndicatorFiller",style:{width:100*e+"%",background:`${t}`}}),c=({values:e,percentage:t,baseColor:n})=>{const[r,i]=(0,s.useState)(!1),c=t>.5?t>.8?"red":"orange":n;return a().createElement("div",{className:"jp-IndicatorBar",onClick:()=>{i(!r)}},r&&a().createElement(o.Sparklines,{data:e,min:0,max:1,limit:e.length,margin:0},a().createElement(o.SparklinesLine,{style:{stroke:c,strokeWidth:4,fill:c,fillOpacity:1}}),a().createElement(o.SparklinesSpots,null)),!r&&a().createElement(l,{percentage:t,color:c}))},u=({enabled:e,values:t,label:n,color:r,text:i})=>{const s=t[t.length-1];return e&&a().createElement("div",{className:"jp-IndicatorContainer"},a().createElement("div",{className:"jp-IndicatorText"},n),null!==s&&a().createElement("div",{className:"jp-IndicatorWrapper"},a().createElement(c,{values:t,percentage:s,baseColor:r})),a().createElement("div",{className:"jp-IndicatorText"},i))},p=({model:e,label:t})=>{const[n,r]=(0,s.useState)(""),[i,o]=(0,s.useState)([]),l=()=>{const{currentCpuPower:t,currentCpuPowerLimit:n}=e,i=`${t.toFixed(2)} ${n?"/ "+n.toFixed(0):""} W`,s=e.values.map((e=>e.cpuPowerShare));r(i),o(s)};return(0,s.useEffect)((()=>(e.changed.connect(l),()=>{e.changed.disconnect(l)})),[e]),a().createElement(u,{enabled:e.cpuPowerAvailable,values:i,label:t,color:"#1AB7AE",text:n})};var d;!function(e){e.createPowerView=(e,t)=>r.ReactWidget.create(a().createElement(p,{model:e,label:t}))}(d||(d={}));const h=({model:e,label:t})=>{const[n,r]=(0,s.useState)(""),[i,o]=(0,s.useState)([]),l=()=>{const{currentGpuPower:t,currentGpuLimit:n}=e,i=`${t.toFixed(2)} ${n?"/ "+n.toFixed(0):""} W`,s=e.values.map((e=>e.gpuPowerShare));r(i),o(s)};return(0,s.useEffect)((()=>(e.changed.connect(l),()=>{e.changed.disconnect(l)})),[e]),a().createElement(u,{enabled:e.gpuPowerAvailable,values:i,label:t,color:"#76B900",text:n})};var m;!function(e){e.createPowerView=(e,t)=>r.ReactWidget.create(a().createElement(h,{model:e,label:t}))}(m||(m={}));const g=({enabled:e,text:t})=>e&&a().createElement("div",{className:"jp-IndicatorContainer"},a().createElement("div",{className:"jp-IndicatorText"},a().createElement("span",null,"eCO",a().createElement("sub",null,"2"),":")),a().createElement("div",{className:"jp-IndicatorText"},t)),f=({model:e})=>{const[t,n]=(0,s.useState)(""),r=()=>{const{currentEmissions:t,emissionsUnits:r}=e,i=["mg","g","kg"].indexOf(r)>0?0:2,s=`${t.toFixed(i)} ${e.emissionsUnits}`;n(s)};return(0,s.useEffect)((()=>(e.changed.connect(r),()=>{e.changed.disconnect(r)})),[e]),a().createElement(g,{enabled:e.emissionsAvailable,text:t})};var v;!function(e){e.createEmissionsView=e=>r.ReactWidget.create(a().createElement(f,{model:e}))}(v||(v={}));var w=n(614),_=n(788),b=n(797),P=n(901);const E=1e3,y=1e6;var x;!function(e){e.getOpenDataSoftEmissions=async()=>{var e,t;const n={dataset:"eco2mix-national-tr",facet:"date_heure",start:"0",rows:"1",sort:"date_heure",timezone:"Europe/Paris",q:`date_heure:[${(new Date).toISOString().split("T")[0]} TO #now()] AND NOT #null(taux_co2)`},r=w.URLExt.objectToQueryString(n),i=w.URLExt.join("https://odre.opendatasoft.com","/api/records/1.0/search/",r);try{const n=await fetch(i,{method:"GET"});if(!n.ok)return console.debug("Request to Opendatasoft API failed"),null;const r=await n.json();if(r&&r.records&&r.records.length>0)return(null===(t=null===(e=r.records[0])||void 0===e?void 0:e.fields)||void 0===t?void 0:t.taux_co2)||0}catch(e){return console.info(`Request to Opendatasoft API failed due to ${e}`),null}return null}}(x||(x={}));var A,C,U;!function(e){class t extends r.VDomModel{constructor(e,t){super(),this._cpuPowerUsageAvailable=!1,this._gpuPowerUsageAvailable=!1,this._emissionsAvailable=!1,this._currentCpuPowerLimit=null,this._currentCpuPowerUsage=null,this._currentGpuPowerUsage=null,this._currentGpuPowerLimit=null,this._currentEmissions=null,this._lastEmissionReading=Date.now(),this._lastEmissionFactor=null,this._totalEmissions=0,this._values=[],this._emissionModel=e;for(let e=0;e<20;e++)this._values.push({cpuPowerShare:0,gpuPowerShare:0});this._poll=new b.Poll({factory:()=>U.powerUsageFactory(),frequency:{interval:t.refreshRate,backoff:!0},name:"jupyter-power-usage:PowerUsage#metrics"}),this._poll.ticked.connect((e=>{const{payload:t,phase:n}=e.state;if("resolved"!==n){if("rejected"===n){const e=this._cpuPowerUsageAvailable;return this._cpuPowerUsageAvailable=!1,this._gpuPowerUsageAvailable=!1,this._emissionsAvailable=!1,this._currentCpuPowerLimit=null,this._currentCpuPowerUsage=null,this._currentGpuPowerUsage=null,this._currentGpuPowerLimit=null,this._currentEmissions=null,void(e&&this.stateChanged.emit())}}else this._updateMetricsValues(t)}))}async refresh(){await this._poll.refresh(),await this._poll.tick}get cpuPowerAvailable(){return this._cpuPowerUsageAvailable}get gpuPowerAvailable(){return this._gpuPowerUsageAvailable}get emissionsAvailable(){return this._emissionsAvailable&&(this._cpuPowerUsageAvailable||this._gpuPowerUsageAvailable)}get currentCpuPower(){return this._currentCpuPowerUsage}get currentCpuPowerLimit(){return this._currentCpuPowerLimit}get currentGpuPower(){return this._currentGpuPowerUsage}get currentGpuLimit(){return this._currentGpuPowerLimit}get currentEmissions(){return this._currentEmissions}get totalEmissions(){return this._totalEmissions}get emissionsUnits(){return this._emissionsUnits}get changed(){return this.stateChanged}get values(){return this._values}dispose(){this._poll.dispose()}_updateMetricsValues(e){if(null===e)return this._cpuPowerUsageAvailable=!1,this._gpuPowerUsageAvailable=!1,this._emissionsAvailable=!1,this._currentCpuPowerLimit=null,this._currentCpuPowerUsage=null,this._currentGpuPowerUsage=null,this._currentGpuPowerLimit=null,void(this._currentEmissions=null);const t=e.cpu?e.cpu.usage:null,n=e.cpu?e.cpu.limit:null;this._cpuPowerUsageAvailable=!!t,this._currentCpuPowerUsage=t,this._currentCpuPowerLimit=n;const r=e.gpu?e.gpu.usage:null,i=e.gpu?e.gpu.limit:null;this._gpuPowerUsageAvailable=!!r,this._currentGpuPowerUsage=r,this._currentGpuPowerLimit=i;const{emissionFactorAvailable:s,currentEmissionFactor:a}=this._emissionModel;if(this._lastEmissionFactor=s?a:this._lastEmissionFactor,this._emissionsAvailable=null!==this._lastEmissionFactor,this._emissionsAvailable){const e=Date.now()-this._lastEmissionReading,n=(t||0)+(r||0),i=this._lastEmissionFactor*n*e/1e3;this._lastEmissionReading=Date.now();const s=this._totalEmissions+i,[a,l]=(o=s)?o<E?[o,"mg"]:E===o||o<y?[o/E,"g"]:[o/y,"kg"]:[0,"mg"];this._currentEmissions=a,this._emissionsUnits=l,this._totalEmissions=s}var o;const l=this._currentCpuPowerLimit?Math.min(this._currentCpuPowerUsage/this._currentCpuPowerLimit,1):null,c=this._currentGpuPowerUsage&&this._currentGpuPowerLimit?Math.min(this._currentGpuPowerUsage/this._currentGpuPowerLimit,1):null;this._values.push({cpuPowerShare:l,gpuPowerShare:c}),this._values.shift(),this.stateChanged.emit(void 0)}}e.Model=t}(A||(A={})),function(e){e.Model=class{constructor(e){this._emissionFactorAvailable=!1,this._currentEmissionFactor=null,this._changed=new P.Signal(this),this._poll=new b.Poll({factory:()=>U.emissionsFactory(e.countryCode,e.defaultEmissionFactor),frequency:{interval:e.refreshRate,backoff:!0},name:"jupyter-power-usage:EmissionFactor#metrics"}),this._poll.ticked.connect((e=>{const{payload:t,phase:n}=e.state;if("resolved"!==n){if("rejected"===n){const e=this._emissionFactorAvailable;return this._emissionFactorAvailable=!1,this._currentEmissionFactor=null,void(e&&this._changed.emit())}}else this._updateMetricsValues(t)}))}async refresh(){await this._poll.refresh(),await this._poll.tick}get emissionFactorAvailable(){return this._emissionFactorAvailable}get currentEmissionFactor(){return this._currentEmissionFactor}dispose(){this._poll.dispose()}_updateMetricsValues(e){if(null===e)return this._emissionFactorAvailable=!1,void(this._currentEmissionFactor=null);const t=e;this._emissionFactorAvailable=null!==t,this._currentEmissionFactor=t,this._changed.emit(void 0)}}}(C||(C={})),function(e){const t=_.ServerConnection.makeSettings(),n=w.URLExt.join(t.baseUrl,"api/metrics/v1/power_usage");e.powerUsageFactory=async()=>{const e=_.ServerConnection.makeRequest(n,{},t),r=await e;return r.ok?await r.json():null},e.emissionsFactory=async(e,t)=>{const n=await async function(e){return"fr"===e?await x.getOpenDataSoftEmissions():null}(e);return n?n/3600:t/3600}}(U||(U={}));var F=n(379),S=n.n(F),j=n(795),I=n.n(j),k=n(569),L=n.n(k),T=n(565),R=n.n(T),G=n(216),M=n.n(G),N=n(589),O=n.n(N),V=n(760),D={};D.styleTagTransform=O(),D.setAttributes=R(),D.insert=L().bind(null,"head"),D.domAPI=I(),D.insertStyleElement=M(),S()(V.Z,D),V.Z&&V.Z.locals&&V.Z.locals;const W=5e3,$=18e5,q={id:"@mahendrapaipuri/jupyter-power-usage:plugin",autoStart:!0,requires:[r.IToolbarWidgetRegistry],optional:[i.ISettingRegistry],activate:async(e,t,n)=>{console.log("@mahendrapaipuri/jupyter-power-usage extension is activated");let r=W,i="CPU Power: ",s="GPU Power: ",a=$,o="fr",l=475;if(n){const e=await n.load(q.id);r=e.get("refreshRate").composite,r<W&&(console.log("Refresh rate is floored at 5000 ms"),r=W);const t=e.get("emissions").composite;o=t.countryCode,a=t.refreshRate,l=t.factor,a<$&&(console.log("Emissions update interval is floored at 1800000 ms"),a=$);const c=e.get("cpu").composite;i=c.label;const u=e.get("gpu").composite;s=u.label}const c=new C.Model({refreshRate:a,countryCode:o,defaultEmissionFactor:l});await c.refresh();const u=new A.Model(c,{refreshRate:r});await u.refresh(),u.cpuPowerAvailable||u.gpuPowerAvailable||(console.log("Power metrics are not available..."),u.dispose(),c.dispose()),u.cpuPowerAvailable&&t.addFactory("TopBar","cpu_power",(()=>d.createPowerView(u,i))),u.gpuPowerAvailable&&t.addFactory("TopBar","gpu_power",(()=>m.createPowerView(u,s))),u.emissionsAvailable&&t.addFactory("TopBar","emissions",(()=>v.createEmissionsView(u)))}},B=q},150:(e,t,n)=>{n.d(t,{Z:()=>o});var r=n(81),i=n.n(r),s=n(645),a=n.n(s)()(i());a.push([e.id,".jp-IndicatorContainer {\n  display: flex;\n  flex-direction: row;\n}\n\n.jp-IndicatorFiller {\n  height: 100%;\n}\n\n.jp-IndicatorText {\n  display: flex;\n  min-width: 35px;\n  flex-direction: column;\n  justify-content: center;\n  text-align: right;\n  white-space: nowrap;\n  overflow: hidden;\n}\n\n.jp-IndicatorWrapper {\n  display: flex;\n  flex-direction: column;\n  justify-content: center;\n  margin-left: 5px;\n  margin-right: 5px;\n  width: 75px;\n}\n\n.jp-IndicatorBar {\n  height: 75%;\n  outline: 1px solid black;\n}\n\n.jp-IndicatorBar svg {\n  max-width: 100%;\n  height: 100%;\n}\n\n/* To center the subscript in the text */\nsub {\n  top: 0;\n  bottom: 0;\n  line-height: 1;\n  font-size: 0.5em;\n}\n",""]);const o=a},760:(e,t,n)=>{n.d(t,{Z:()=>c});var r=n(81),i=n.n(r),s=n(645),a=n.n(s),o=n(150),l=a()(i());l.i(o.Z),l.push([e.id,"\n",""]);const c=l},645:e=>{e.exports=function(e){var t=[];return t.toString=function(){return this.map((function(t){var n="",r=void 0!==t[5];return t[4]&&(n+="@supports (".concat(t[4],") {")),t[2]&&(n+="@media ".concat(t[2]," {")),r&&(n+="@layer".concat(t[5].length>0?" ".concat(t[5]):""," {")),n+=e(t),r&&(n+="}"),t[2]&&(n+="}"),t[4]&&(n+="}"),n})).join("")},t.i=function(e,n,r,i,s){"string"==typeof e&&(e=[[null,e,void 0]]);var a={};if(r)for(var o=0;o<this.length;o++){var l=this[o][0];null!=l&&(a[l]=!0)}for(var c=0;c<e.length;c++){var u=[].concat(e[c]);r&&a[u[0]]||(void 0!==s&&(void 0===u[5]||(u[1]="@layer".concat(u[5].length>0?" ".concat(u[5]):""," {").concat(u[1],"}")),u[5]=s),n&&(u[2]?(u[1]="@media ".concat(u[2]," {").concat(u[1],"}"),u[2]=n):u[2]=n),i&&(u[4]?(u[1]="@supports (".concat(u[4],") {").concat(u[1],"}"),u[4]=i):u[4]="".concat(i)),t.push(u))}},t}},81:e=>{e.exports=function(e){return e[1]}},379:e=>{var t=[];function n(e){for(var n=-1,r=0;r<t.length;r++)if(t[r].identifier===e){n=r;break}return n}function r(e,r){for(var s={},a=[],o=0;o<e.length;o++){var l=e[o],c=r.base?l[0]+r.base:l[0],u=s[c]||0,p="".concat(c," ").concat(u);s[c]=u+1;var d=n(p),h={css:l[1],media:l[2],sourceMap:l[3],supports:l[4],layer:l[5]};if(-1!==d)t[d].references++,t[d].updater(h);else{var m=i(h,r);r.byIndex=o,t.splice(o,0,{identifier:p,updater:m,references:1})}a.push(p)}return a}function i(e,t){var n=t.domAPI(t);return n.update(e),function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap&&t.supports===e.supports&&t.layer===e.layer)return;n.update(e=t)}else n.remove()}}e.exports=function(e,i){var s=r(e=e||[],i=i||{});return function(e){e=e||[];for(var a=0;a<s.length;a++){var o=n(s[a]);t[o].references--}for(var l=r(e,i),c=0;c<s.length;c++){var u=n(s[c]);0===t[u].references&&(t[u].updater(),t.splice(u,1))}s=l}}},569:e=>{var t={};e.exports=function(e,n){var r=function(e){if(void 0===t[e]){var n=document.querySelector(e);if(window.HTMLIFrameElement&&n instanceof window.HTMLIFrameElement)try{n=n.contentDocument.head}catch(e){n=null}t[e]=n}return t[e]}(e);if(!r)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");r.appendChild(n)}},216:e=>{e.exports=function(e){var t=document.createElement("style");return e.setAttributes(t,e.attributes),e.insert(t,e.options),t}},565:(e,t,n)=>{e.exports=function(e){var t=n.nc;t&&e.setAttribute("nonce",t)}},795:e=>{e.exports=function(e){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var t=e.insertStyleElement(e);return{update:function(n){!function(e,t,n){var r="";n.supports&&(r+="@supports (".concat(n.supports,") {")),n.media&&(r+="@media ".concat(n.media," {"));var i=void 0!==n.layer;i&&(r+="@layer".concat(n.layer.length>0?" ".concat(n.layer):""," {")),r+=n.css,i&&(r+="}"),n.media&&(r+="}"),n.supports&&(r+="}");var s=n.sourceMap;s&&"undefined"!=typeof btoa&&(r+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(s))))," */")),t.styleTagTransform(r,e,t.options)}(t,e,n)},remove:function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(t)}}}},589:e=>{e.exports=function(e,t){if(t.styleSheet)t.styleSheet.cssText=e;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(e))}}}}]);