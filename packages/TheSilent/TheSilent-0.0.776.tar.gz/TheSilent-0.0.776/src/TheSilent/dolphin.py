import asyncio
import ipaddress
import random
import re
import resource
import socket
import time
from TheSilent.clear import clear

CYAN = "\033[1;36m"

async def host_sweep(host):
    # check port 80
    try:
        success = False
        coro = asyncio.open_connection(host,80)
        _,writer = await asyncio.wait_for(coro,timeout=1.25)
        success = True
    except ConnectionRefusedError:
        success = True
    except:
        pass
    # check port 443
    try:
        success = False
        coro = asyncio.open_connection(host,443)
        _,writer = await asyncio.wait_for(coro,timeout=1.25)
        success = True
    except ConnectionRefusedError:
        success = True
    except:
        pass
    if success:
        return host

async def host_scan(host,port):
    for _ in range(10):
        try:
            success = False
            coro = asyncio.open_connection(host,port)
            _,writer = await asyncio.wait_for(coro,timeout=10)  
            success = True
            banner = await asyncio.wait_for(_.read(65536),timeout=5)
            return f"{host}:{port}- {banner}"

        except ConnectionRefusedError:
            break

        except:
            if success:
                return f"{host}:{port}- no banner"

def dolphin(host,host_only=False,delay=0):
    global banner_list
    global reverse_dns
    banner_list = []
    reverse_dns = []
    print(CYAN + "")
    clear()
    host_list = []
    _,hard = resource.getrlimit(resource.RLIMIT_NOFILE)
    resource.setrlimit(resource.RLIMIT_NOFILE,(hard,hard))
    if re.search("^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}/\d{1,2}$",host):
        if host_only:
            print(CYAN + "running host sweep")
            host_list = []
            init_host_list = list(ipaddress.ip_network(host,strict=False).hosts())
            for _ in init_host_list:
                host_list.append(str(_))

            host_list = random.sample(host_list[:],len(host_list[:]))
            hosts = []
            for _,__ in enumerate(host_list):
                hosts.append(__)
                if _ % 255 == 0:
                    loop = asyncio.get_event_loop()
                    scans = asyncio.gather(*[host_sweep(host) for host in hosts])
                    banners = loop.run_until_complete(scans)
                    for banner in banners:
                        if banner != None:
                            banner_list.append(banner)
                    hosts = []
                if _ == len(host_list) - 1 and _ % 255 != 0:
                    loop = asyncio.get_event_loop()
                    scans = asyncio.gather(*[host_sweep(host) for host in hosts])
                    banners = loop.run_until_complete(scans)
                    for banner in banners:
                        if banner != None:
                            banner_list.append(banner)
                    hosts = []

            banner_list = list(set(banner_list[:]))
            banner_list.sort()
            return banner_list
        
        init_host_list = list(ipaddress.ip_network(host,strict=False).hosts())
        for _ in init_host_list:
            host_list.append(str(_))

        host_list = random.sample(host_list[:],len(host_list[:]))
        for host in host_list:
            time.sleep(delay)
            try:
                reverse_dns.append(f"{host}/reverse dns: {socket.gethostbyaddr(host)}")
            except socket.gaierror:
                continue
            except:
                pass

            if not host_only:
                print(CYAN + f"scanning the top 1,000 ports on: {host}")
                # top 1,000 ports according to nmap
                init_ports = [1,100,1000,10000,10001,10002,10003,10004,10009,1001,10010,10012,1002,10024,10025,1007,10082,1009,1010,1011,10180,1021,10215,1022,1023,1024,10243,1025,1026,1027,1028,1029,1030,1031,1032,1033,1034,1035,1036,1037,1038,1039,1040,1041,1042,1043,1044,1045,1046,1047,1048,1049,1050,1051,1052,1053,1054,1055,1056,10566,1057,1058,1059,106,1060,1061,10616,10617,1062,10621,10626,10628,10629,1063,1064,1065,1066,1067,1068,1069,1070,1071,1072,1073,1074,1075,1076,1077,10778,1078,1079,1080,1081,1082,1083,1084,1085,1086,1087,1088,1089,109,1090,1091,1093,1094,1096,1097,1098,1099,110,1100,1104,1106,1107,1108,111,1110,1111,11110,11111,1112,1114,1117,1119,1122,1124,113,1131,1138,1148,1151,1152,1169,1175,1183,1186,119,11967,1199,12000,1201,12174,1218,12265,1234,12345,1247,1248,125,1271,1272,1296,13,1310,1311,1334,13456,135,1352,13722,13782,13783,139,14000,1417,14238,143,1433,1434,144,1443,14441,14442,1455,146,1461,1494,1500,15000,15002,15003,15004,1501,1503,1521,1524,1533,15660,15742,1580,1600,16000,16001,16012,16016,16018,16080,161,16113,163,1666,1687,16992,16993,17,1700,1717,1718,1720,1723,1755,1761,1782,1783,17877,179,17988,1801,18040,18101,1840,1862,1863,1864,18988,19,1900,19101,19283,19315,1935,19350,1947,19780,19801,1984,19842,199,1998,1999,20,2000,20000,20005,2001,2002,2003,20031,2004,2005,2006,2007,2008,2009,2010,2013,2020,2021,2022,20221,20222,2030,2033,2034,2035,2038,2040,2041,2042,2043,2045,2046,2047,2048,2049,2065,2068,20828,21,2100,2103,2105,2106,2107,211,2111,2119,212,2121,2126,2135,2144,21571,2160,2161,2179,2190,2191,22,222,2222,2251,2260,22939,23,2301,2323,23502,2381,2383,2393,2394,2399,24,2401,24444,24800,2492,25,2500,2522,2525,254,255,256,25734,25735,259,26,2601,2602,2604,2605,2607,2608,26214,2638,264,27000,2701,2702,2717,2718,2725,27352,27353,27355,27356,27715,280,2809,2811,28201,2869,2875,2909,2967,2998,3,30,3000,30000,3001,3003,3005,3006,301,3011,3017,3030,3031,3052,306,3071,30718,3077,30951,31038,311,3128,31337,3168,32,3211,3221,3260,3261,3268,3269,32768,32769,32770,32771,32772,32773,32774,32775,32776,32777,32778,32779,32780,32781,32782,32783,32784,32785,3283,33,3300,3301,3306,3322,3323,3324,3325,3333,33354,3351,3367,3369,3370,3371,3372,3389,33899,3390,340,3404,34571,34572,34573,3476,3493,3517,3527,3546,35500,3551,3580,3659,366,3689,3690,37,3703,3737,3766,3784,3800,3801,3809,3814,3826,3827,3828,38292,3851,3869,3871,3878,3880,3889,389,389,3905,3914,3918,3920,3945,3971,3986,3995,3998,4,4000,4001,4002,4003,4004,4005,4006,40193,4045,406,407,40911,4111,4125,4126,4129,41511,416,417,42,4224,4242,425,42510,427,4279,43,4321,4343,44176,443,444,4443,4444,44442,44443,4445,4446,4449,445,44501,45100,4550,4567,458,464,465,4662,48080,481,4848,4899,49,4900,49152,49153,49154,49155,49156,49157,49158,49159,49160,49161,49163,49165,49167,49175,49176,49400,497,4998,49999,500,5000,50000,50001,50002,50003,50006,5001,5002,5003,5004,5009,5030,50300,5033,50389,5050,50500,5051,5054,5060,5061,50636,5080,50800,5087,5100,5101,5102,51103,512,5120,513,514,51493,515,5190,5200,5214,5221,5222,5225,5226,524,52673,5269,5280,52822,52848,52869,5298,53,5357,54045,5405,541,5414,543,5431,5432,54328,544,5440,545,548,5500,55055,55056,5510,554,5544,555,5550,5555,55555,5560,55600,5566,563,5631,5633,5666,56737,56738,5678,5679,5718,57294,5730,57797,5800,5801,5802,58080,5810,5811,5815,5822,5825,5850,5859,5862,587,5877,5900,5901,5902,5903,5904,5906,5907,5910,5911,5915,5922,5925,593,5950,5952,5959,5960,5961,5962,5963,5987,5988,5989,5998,5999,6,6000,6001,6002,60020,6003,6004,6005,6006,6007,6009,6025,60443,6059,6100,6101,6106,6112,6123,6129,61532,6156,616,617,61900,62078,6247,625,631,63331,6346,636,6389,646,64623,64680,648,6481,6500,65000,6502,6504,6510,65129,6520,65310,65389,6543,6547,6550,6565,6566,6567,6580,6600,6646,666,6666,6667,6668,6669,667,668,6689,6692,6699,6711,6732,6779,6788,6789,6792,683,6839,687,6881,6896,6901,691,6969,7,70,700,7000,7001,7002,7004,7007,7019,7024,7025,705,7050,7051,7070,7080,7100,7103,7106,711,7123,714,720,7200,7201,722,7241,726,7272,7278,7281,7402,7435,7438,7443,749,7496,7512,7625,7627,765,7676,7725,7741,7744,7749,777,7770,7777,7778,7800,783,787,7878,79,7900,7911,7913,7920,7921,7929,7937,7938,7999,80,800,8000,8001,8002,8007,8008,8009,801,8010,8011,8015,8016,8019,8021,8022,8031,8042,8045,8050,808,8080,8081,8082,8083,8084,8085,8086,8087,8088,8089,8090,8093,8095,8097,8098,8099,81,8100,8180,8181,8189,8192,8193,8194,82,8200,8222,8254,8290,8291,8292,8293,8294,83,8300,8333,8383,8385,84,8400,8402,843,8443,8481,85,8500,8540,8600,8648,8649,8651,8652,8654,8675,8676,8686,8701,873,8765,8766,88,880,8800,8873,8877,888,8888,8889,8899,89,898,8987,8994,8996,9,90,900,9000,9001,9002,9003,9009,901,9010,9011,902,903,9040,9050,9071,9080,9081,9090,9091,9098,9099,9100,9101,9102,9103,911,9110,9111,912,9191,9197,9198,9200,9207,9220,9290,9409,9415,9418,9443,9444,9485,9500,9501,9502,9503,9535,9575,9593,9594,9595,9600,9618,9621,9643,9666,9673,981,9815,987,9876,9877,9878,9898,99,990,9900,9914,9917,992,9929,993,9941,9943,9944,995,9968,9988,999,9998,9999]
                loop = asyncio.get_event_loop()
                scans = asyncio.gather(*[host_scan(host,port) for port in init_ports])
                banners = loop.run_until_complete(scans)
                for banner in banners:
                    if banner != None:
                        banner_list.append(banner)

    else:
        try:
            reverse_dns.append(f"{host}/reverse dns: {socket.gethostbyaddr(host)}")
        except socket.gaierror:
            return ["host is down or doesn't exist"]
        except:
            pass

        if not host_only:
            print(CYAN + f"scanning the top 1,000 ports on: {host}")
            # top 1,000 ports according to nmap
            init_ports = [1,100,1000,10000,10001,10002,10003,10004,10009,1001,10010,10012,1002,10024,10025,1007,10082,1009,1010,1011,10180,1021,10215,1022,1023,1024,10243,1025,1026,1027,1028,1029,1030,1031,1032,1033,1034,1035,1036,1037,1038,1039,1040,1041,1042,1043,1044,1045,1046,1047,1048,1049,1050,1051,1052,1053,1054,1055,1056,10566,1057,1058,1059,106,1060,1061,10616,10617,1062,10621,10626,10628,10629,1063,1064,1065,1066,1067,1068,1069,1070,1071,1072,1073,1074,1075,1076,1077,10778,1078,1079,1080,1081,1082,1083,1084,1085,1086,1087,1088,1089,109,1090,1091,1093,1094,1096,1097,1098,1099,110,1100,1104,1106,1107,1108,111,1110,1111,11110,11111,1112,1114,1117,1119,1122,1124,113,1131,1138,1148,1151,1152,1169,1175,1183,1186,119,11967,1199,12000,1201,12174,1218,12265,1234,12345,1247,1248,125,1271,1272,1296,13,1310,1311,1334,13456,135,1352,13722,13782,13783,139,14000,1417,14238,143,1433,1434,144,1443,14441,14442,1455,146,1461,1494,1500,15000,15002,15003,15004,1501,1503,1521,1524,1533,15660,15742,1580,1600,16000,16001,16012,16016,16018,16080,161,16113,163,1666,1687,16992,16993,17,1700,1717,1718,1720,1723,1755,1761,1782,1783,17877,179,17988,1801,18040,18101,1840,1862,1863,1864,18988,19,1900,19101,19283,19315,1935,19350,1947,19780,19801,1984,19842,199,1998,1999,20,2000,20000,20005,2001,2002,2003,20031,2004,2005,2006,2007,2008,2009,2010,2013,2020,2021,2022,20221,20222,2030,2033,2034,2035,2038,2040,2041,2042,2043,2045,2046,2047,2048,2049,2065,2068,20828,21,2100,2103,2105,2106,2107,211,2111,2119,212,2121,2126,2135,2144,21571,2160,2161,2179,2190,2191,22,222,2222,2251,2260,22939,23,2301,2323,23502,2381,2383,2393,2394,2399,24,2401,24444,24800,2492,25,2500,2522,2525,254,255,256,25734,25735,259,26,2601,2602,2604,2605,2607,2608,26214,2638,264,27000,2701,2702,2717,2718,2725,27352,27353,27355,27356,27715,280,2809,2811,28201,2869,2875,2909,2967,2998,3,30,3000,30000,3001,3003,3005,3006,301,3011,3017,3030,3031,3052,306,3071,30718,3077,30951,31038,311,3128,31337,3168,32,3211,3221,3260,3261,3268,3269,32768,32769,32770,32771,32772,32773,32774,32775,32776,32777,32778,32779,32780,32781,32782,32783,32784,32785,3283,33,3300,3301,3306,3322,3323,3324,3325,3333,33354,3351,3367,3369,3370,3371,3372,3389,33899,3390,340,3404,34571,34572,34573,3476,3493,3517,3527,3546,35500,3551,3580,3659,366,3689,3690,37,3703,3737,3766,3784,3800,3801,3809,3814,3826,3827,3828,38292,3851,3869,3871,3878,3880,3889,389,389,3905,3914,3918,3920,3945,3971,3986,3995,3998,4,4000,4001,4002,4003,4004,4005,4006,40193,4045,406,407,40911,4111,4125,4126,4129,41511,416,417,42,4224,4242,425,42510,427,4279,43,4321,4343,44176,443,444,4443,4444,44442,44443,4445,4446,4449,445,44501,45100,4550,4567,458,464,465,4662,48080,481,4848,4899,49,4900,49152,49153,49154,49155,49156,49157,49158,49159,49160,49161,49163,49165,49167,49175,49176,49400,497,4998,49999,500,5000,50000,50001,50002,50003,50006,5001,5002,5003,5004,5009,5030,50300,5033,50389,5050,50500,5051,5054,5060,5061,50636,5080,50800,5087,5100,5101,5102,51103,512,5120,513,514,51493,515,5190,5200,5214,5221,5222,5225,5226,524,52673,5269,5280,52822,52848,52869,5298,53,5357,54045,5405,541,5414,543,5431,5432,54328,544,5440,545,548,5500,55055,55056,5510,554,5544,555,5550,5555,55555,5560,55600,5566,563,5631,5633,5666,56737,56738,5678,5679,5718,57294,5730,57797,5800,5801,5802,58080,5810,5811,5815,5822,5825,5850,5859,5862,587,5877,5900,5901,5902,5903,5904,5906,5907,5910,5911,5915,5922,5925,593,5950,5952,5959,5960,5961,5962,5963,5987,5988,5989,5998,5999,6,6000,6001,6002,60020,6003,6004,6005,6006,6007,6009,6025,60443,6059,6100,6101,6106,6112,6123,6129,61532,6156,616,617,61900,62078,6247,625,631,63331,6346,636,6389,646,64623,64680,648,6481,6500,65000,6502,6504,6510,65129,6520,65310,65389,6543,6547,6550,6565,6566,6567,6580,6600,6646,666,6666,6667,6668,6669,667,668,6689,6692,6699,6711,6732,6779,6788,6789,6792,683,6839,687,6881,6896,6901,691,6969,7,70,700,7000,7001,7002,7004,7007,7019,7024,7025,705,7050,7051,7070,7080,7100,7103,7106,711,7123,714,720,7200,7201,722,7241,726,7272,7278,7281,7402,7435,7438,7443,749,7496,7512,7625,7627,765,7676,7725,7741,7744,7749,777,7770,7777,7778,7800,783,787,7878,79,7900,7911,7913,7920,7921,7929,7937,7938,7999,80,800,8000,8001,8002,8007,8008,8009,801,8010,8011,8015,8016,8019,8021,8022,8031,8042,8045,8050,808,8080,8081,8082,8083,8084,8085,8086,8087,8088,8089,8090,8093,8095,8097,8098,8099,81,8100,8180,8181,8189,8192,8193,8194,82,8200,8222,8254,8290,8291,8292,8293,8294,83,8300,8333,8383,8385,84,8400,8402,843,8443,8481,85,8500,8540,8600,8648,8649,8651,8652,8654,8675,8676,8686,8701,873,8765,8766,88,880,8800,8873,8877,888,8888,8889,8899,89,898,8987,8994,8996,9,90,900,9000,9001,9002,9003,9009,901,9010,9011,902,903,9040,9050,9071,9080,9081,9090,9091,9098,9099,9100,9101,9102,9103,911,9110,9111,912,9191,9197,9198,9200,9207,9220,9290,9409,9415,9418,9443,9444,9485,9500,9501,9502,9503,9535,9575,9593,9594,9595,9600,9618,9621,9643,9666,9673,981,9815,987,9876,9877,9878,9898,99,990,9900,9914,9917,992,9929,993,9941,9943,9944,995,9968,9988,999,9998,9999]
            loop = asyncio.get_event_loop()
            scans = asyncio.gather(*[host_scan(host,port) for port in init_ports])
            banners = loop.run_until_complete(scans)
            for banner in banners:
                if banner != None:
                    banner_list.append(banner)

    return banner_list,reverse_dns
