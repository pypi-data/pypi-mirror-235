!function(){var e;e=this,t=function(e){"use strict";e.Avatars={}},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).Djblets=e.Djblets||{}),Djblets.Avatars.Settings=Backbone.Model.extend({defaults(){return{configuration:{},serviceID:null,services:{}}}}),Djblets.Avatars.ServiceSettingsFormView=Backbone.View.extend({validate(){return!0}});{const[a,i]=Promise.withResolver();Djblets.Avatars.SettingsFormView=Backbone.View.extend({events:{"change #id_avatar_service_id":"_onServiceChanged",submit:"_onSubmit"},initialize(){console.assert(null===Djblets.Avatars.SettingsFormView.instance),(Djblets.Avatars.SettingsFormView.instance=this)._configForms=new Map,this._$config=this.$(".avatar-service-configuration"),this.listenTo(this.model,"change:serviceID",()=>this._showHideForms()),i()},_onSubmit(e){var t=this.model.get("serviceID"),t=this._configForms.get(t);t&&!t.validate()&&e.preventDefault()},renderForms(){for(const e of this._configForms.values())e.render();return this.$("#id_avatar_service_id").change(),this._showHideForms(!0),this},_showHideForms(){var e=this.model.get("serviceID"),e=this._configForms.get(e),t=this.model.previous("serviceID"),t=t?this._configForms.get(t):void 0;t&&e?(t.$el.hide(),e.$el.show()):t?(t.$el.hide(),this._$config.hide()):e&&(e.$el.show(),this._$config.show())},_onServiceChanged(e){e=$(e.target);this.model.set("serviceID",e.val())}},{instance:null,addConfigForm(e,t){Djblets.Avatars.SettingsFormView.instance._configForms.set(e,new t({el:$(`[data-avatar-service-id="${e}"]`),model:Djblets.Avatars.SettingsFormView.instance.model}))},ready:a})}{const r=["image/gif","image/jpeg","image/png"];var t=Djblets.Avatars.ServiceSettingsFormView;Djblets.Avatars.FileUploadSettingsFormView=t.extend({events:{"change #id_file-upload-avatar_upload":"_onFileChanged","click .avatar-file-upload-browse":"_onBrowseClicked","click .avatar-preview":"_onBrowseClicked","dragenter .avatar-file-upload-config":"_onDragEnter","dragleave .avatar-file-upload-config":"_onDragLeave","dragover .avatar-file-upload-config":"_onDragOver","drop .avatar-file-upload-config":"_onDrop"},validate(){const t=this._$fileInput[0].files[0];return t?!!r.some(e=>e===t.type)||(alert(gettext("This wasn't a valid image file format. Please provide a PNG, JPEG, or GIF file.")),!1):(alert(gettext("You must choose a file.")),!1)},render(){return this._$box=this.$(".avatar-file-upload-config"),this._$preview=this.$(".avatar-preview"),this._$fileInput=this.$("#id_file-upload-avatar_upload"),this},_onBrowseClicked(e){e.preventDefault(),e.stopPropagation(),this.$("#avatar-file-upload-browse-label").click()},_onDragEnter(e){e.preventDefault(),e.stopPropagation(),e.target===this._$box[0]&&this._$box.width(this._$box.width()).addClass("drag-hover")},_onDragOver(e){e.preventDefault(),e.stopPropagation(),e.target===this._$box[0]&&(e=e.originalEvent.dataTransfer)&&(e.dropEffect="copy")},_onDragLeave(e){e.preventDefault(),e.stopPropagation(),e.target===this._$box[0]&&(this._$box.removeClass("drag-hover").width("auto"),e=e.originalEvent.dataTransfer)&&(e.dropEffect="none")},_onDrop(e){e.preventDefault(),e.stopPropagation(),this._$box.removeClass("drag-hover");e=e.originalEvent.dataTransfer,e=e&&e.files;if(e&&0!==e.length)if(1<e.length)alert(gettext("You can only set one file as your avatar. Please drag and drop a single file."));else{var t=e[0].type;if("image/png"!==t&&"image/jpeg"!==t&&"image/gif"!==t)alert(gettext("This doesn't appear to be a compatible image file for avatars. Please upload a PNG, JPEG, or GIF file."));else{try{this._$fileInput[0].files=e}catch(e){return void alert(gettext("Looks like dragging to upload a file isn't going to work with your browser. Try browsing for a file instead."))}this._setAvatarFromFile(e[0])}}},_onFileChanged(e){e=e.target.files[0];e&&this._setAvatarFromFile(e)},_setAvatarFromFile(e){const t=new FileReader;t.addEventListener("load",()=>{this._$preview.empty().removeClass("avatar-preview-unset").append($("<img />").attr({alt:gettext("Your new avatar"),src:t.result}))}),t.readAsDataURL(e)}})}}.call(this);
