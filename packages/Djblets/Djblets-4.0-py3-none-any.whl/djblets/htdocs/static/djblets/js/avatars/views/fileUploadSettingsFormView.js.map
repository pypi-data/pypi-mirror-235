{"version":3,"file":"fileUploadSettingsFormView.js","names":["allowedMimeTypes","ParentView","Djblets","Avatars","ServiceSettingsFormView","FileUploadSettingsFormView","extend","events","validate","file","_$fileInput","files","alert","some","el","type","render","_$box","$","_$preview","_onBrowseClicked","e","preventDefault","stopPropagation","click","_onDragEnter","target","width","addClass","_onDragOver","dt","originalEvent","dataTransfer","dropEffect","_onDragLeave","removeClass","_onDrop","length","fileType","exc","_setAvatarFromFile","_onFileChanged","reader","FileReader","addEventListener","empty","append","attr","alt","src","result","readAsDataURL"],"sources":["../../../../../../static/djblets/js/avatars/views/fileUploadSettingsFormView.es6.js"],"sourcesContent":["(function() {\n\n\nconst allowedMimeTypes = [\n    'image/gif',\n    'image/jpeg',\n    'image/png',\n];\n\n\nconst ParentView = Djblets.Avatars.ServiceSettingsFormView;\n\n\n/**\n * A file upload avatar settings form.\n *\n * This form provides a preview of the uploaded avatar.\n */\nDjblets.Avatars.FileUploadSettingsFormView = ParentView.extend({\n    events: {\n        'change #id_file-upload-avatar_upload': '_onFileChanged',\n        'click .avatar-file-upload-browse': '_onBrowseClicked',\n        'click .avatar-preview': '_onBrowseClicked',\n        'dragenter .avatar-file-upload-config': '_onDragEnter',\n        'dragleave .avatar-file-upload-config': '_onDragLeave',\n        'dragover .avatar-file-upload-config': '_onDragOver',\n        'drop .avatar-file-upload-config': '_onDrop',\n    },\n\n    /**\n     * Validate the form.\n     *\n     * If a file is selected, ensure it is has the correct MIME type.\n     */\n    validate() {\n        const file = this._$fileInput[0].files[0];\n\n        if (!file) {\n            alert(_`You must choose a file.`);\n\n            return false;\n        }\n\n        if (!allowedMimeTypes.some(el => (el === file.type))) {\n            alert(_`\n                This wasn't a valid image file format. Please provide a PNG,\n                JPEG, or GIF file.\n            `);\n\n            return false;\n        }\n\n        return true;\n    },\n\n    /**\n     * Render the form.\n     *\n     * Returns:\n     *     Djblets.Avatars.FileUploadSettingsFormView:\n     *     This view (for chaining).\n     */\n    render() {\n        this._$box = this.$('.avatar-file-upload-config');\n        this._$preview = this.$('.avatar-preview');\n        this._$fileInput = this.$('#id_file-upload-avatar_upload');\n\n        return this;\n    },\n\n    /**\n     * Handler for a click event on the \"browse\" instruction text.\n     *\n     * This will trigger opening the hidden file input.\n     *\n     * Args:\n     *     e (jQuery.Event):\n     *         The click event.\n     */\n    _onBrowseClicked(e) {\n        e.preventDefault();\n        e.stopPropagation();\n\n        /*\n         * Clicking on the file input itself is not reliable. There are ways\n         * to make it work, but the browser actively avoids letting you do it\n         * if it seems to be hidden. However, it works just fine universally to\n         * click on the label.\n         */\n        this.$('#avatar-file-upload-browse-label').click();\n    },\n\n    /**\n     * Handler for a drag enter event.\n     *\n     * If the configuration box is being hovered over, this will enable the\n     * hover state, giving users an indication that they can drop the image\n     * there.\n     *\n     * Args:\n     *     e (jQuery.Event):\n     *         The drag over event.\n     */\n    _onDragEnter(e) {\n        e.preventDefault();\n        e.stopPropagation();\n\n        if (e.target === this._$box[0]) {\n            this._$box\n                .width(this._$box.width())\n                .addClass('drag-hover');\n        }\n    },\n\n    /**\n     * Handler for a drag over event.\n     *\n     * If the configuration box is being hovered over, this will set the drop\n     * effect.\n     *\n     * Args:\n     *     e (jQuery.Event):\n     *         The drag over event.\n     */\n    _onDragOver(e) {\n        e.preventDefault();\n        e.stopPropagation();\n\n        if (e.target === this._$box[0]) {\n            const dt = e.originalEvent.dataTransfer;\n\n            if (dt) {\n                dt.dropEffect = 'copy';\n            }\n        }\n    },\n\n    /**\n     * Handler for a drag leave event.\n     *\n     * If the configuration box is being left, this will remove the hover state\n     * and reset the drop effect.\n     *\n     * Args:\n     *     e (jQuery.Event):\n     *         The drag leave event.\n     */\n    _onDragLeave(e) {\n        e.preventDefault();\n        e.stopPropagation();\n\n        if (e.target === this._$box[0]) {\n            this._$box\n                .removeClass('drag-hover')\n                .width('auto');\n\n            const dt = e.originalEvent.dataTransfer;\n\n            if (dt) {\n                dt.dropEffect = 'none';\n            }\n        }\n    },\n\n    /**\n     * Handler for a drop operation.\n     *\n     * This will remove the hover state and attempt to set the list of files\n     * on the file input. If this fails (which will be the case on some\n     * browsers with older behavior), the user will receive an alert telling\n     * them it failed and to try browsing instead.\n     *\n     * If all goes well, the avatar will be ready for upload and the preview\n     * image will be updated.\n     *\n     * Args:\n     *     e (jQuery.Event):\n     *         The drop event.\n     */\n    _onDrop(e) {\n        e.preventDefault();\n        e.stopPropagation();\n\n        this._$box.removeClass('drag-hover');\n\n        const dt = e.originalEvent.dataTransfer;\n        const files = dt && dt.files;\n\n        if (!files || files.length === 0) {\n            return;\n        }\n\n        if (files.length > 1) {\n            alert(_`\n                You can only set one file as your avatar. Please drag and\n                drop a single file.\n            `);\n\n            return;\n        }\n\n        const fileType = files[0].type;\n\n        if (fileType !== 'image/png' && fileType !== 'image/jpeg' &&\n            fileType !== 'image/gif') {\n            alert(_`\n                This doesn't appear to be a compatible image file for avatars.\n                Please upload a PNG, JPEG, or GIF file.\n            `);\n\n            return;\n        }\n\n        try {\n            this._$fileInput[0].files = files;\n        } catch (exc) {\n            /*\n             * While most modern browsers allow setting the `files` property of\n             * an input field to the rest of a drag-and-drop operation, not all\n             * do (I'm looking at you, IE/Edge). Older browsers will also\n             * complain. So instead of outright failing, tell the user that\n             * this won't work and suggest a workaround.\n             */\n            alert(_`\n                Looks like dragging to upload a file isn't going to work with\n                your browser. Try browsing for a file instead.\n            `);\n\n            return;\n        }\n\n        this._setAvatarFromFile(files[0]);\n    },\n\n    /**\n     * Handler for when the file input has changed.\n     *\n     * This will update the preview image.\n     *\n     * Args:\n     *     e (jQuery.Event):\n     *         The change event.\n     */\n    _onFileChanged(e) {\n        const file = e.target.files[0];\n\n        if (file) {\n            this._setAvatarFromFile(file);\n        }\n    },\n\n    /**\n     * Set the avatar from the provided file upload.\n     *\n     * Args:\n     *     file (File):\n     *         The file that was uploaded.\n     */\n    _setAvatarFromFile(file) {\n        const reader = new FileReader();\n\n        reader.addEventListener('load', () => {\n            this._$preview\n                .empty()\n                .removeClass('avatar-preview-unset')\n                .append($('<img />').attr({\n                    alt: _`Your new avatar`,\n                    src: reader.result,\n                }));\n        });\n\n        reader.readAsDataURL(file);\n    },\n});\n\n\n})();\n"],"mappings":"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"}